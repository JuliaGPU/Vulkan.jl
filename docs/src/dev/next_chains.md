# Next chains

Vulkan has a concept of `next` chains, where API structures can be chained together by filling an optional `next` field (hence the name).

This poses a few challenges on the Julia side, because such chains are linked lists which use raw pointers. Raw pointers are the reason why we required so-called intermediate structures that wrap core structures. As a reminder, these intermediate structures are nothing more than a core structure put alongside a vector of dependencies which holds Julia objects (arrays or references). These dependencies are what guarantees the validity of pointers present in the core structure, by making the garbage collector aware that these references must not be freed as long as the core structure is used (i.e., as long as the intermediate wrapper is used).

Having linked lists with opaque pointers complicate the matter. First, one must be able to build such chains to pass in the data structures to Vulkan in the format the API expects. That is the easiest part: we can always have `next` objects in high-level wrappers, build a reference to these (immutable) objects and then turn these references into pointers. However, when handing out a `next` chain to be filled in from the API, one must reconstruct the original object. If the result is meant to be an intermediate structure, we can simply wrap the core object, the dependency being the original intermediate object that was used to initialize the object and its chain. If we want a high-level structure instead, then we simply chase pointers iteratively from `next` chain of the core object, reconstructing the `next` objects by loading the pointers as we go along.

It becomes more complicated when one wants to initialize an empty intermediate object with a `next` chain. We must both reconstruct the core object and the dependencies; care must be taken because every reference used by subsequently chained structures must be retained as dependencies. Therefore, in `initialize`, references are first built all chained types, and the references get filled in `initialize_core` by the initialized core structures before being converted into pointers.
